{% extends "insumos/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Gestión de Usuarios</h3>
  <a class="btn btn-primary" href="{% url 'usuarios:new' %}">+ Nuevo usuario</a>
</div>

<form class="row g-2 mb-3">
  <div class="col-auto">
    <input class="form-control" type="search" name="q" value="{{ request.GET.q }}" placeholder="Buscar por usuario o nombre">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary">Buscar</button>
  </div>
</form>

<div class="table-responsive">
<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Usuario</th>
      <th>Nombre</th>
      <th>Email</th>
      <th>Roles</th>
      <th>Activo</th>
      <th class="text-end">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for u in usuarios %}
    <tr class="{% if not u.is_active %}table-warning{% endif %}">
      <td>{{ u.username }}</td>
      <td>{{ u.get_full_name|default:'-' }}</td>
      <td>{{ u.email|default:'-' }}</td>
      <td>
        {% for g in u.groups.all %}
          <span class="badge text-bg-secondary">{{ g.name }}</span>
        {% empty %}
          <span class="text-muted">Sin rol</span>
        {% endfor %}
      </td>
      <td>
        {% if u.is_active %}
          <span class="badge text-bg-success">Sí</span>
        {% else %}
          <span class="badge text-bg-danger">No</span>
        {% endif %}
      </td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'usuarios:edit' u.pk %}">Editar</a>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'usuarios:roles' u.pk %}">Roles</a>
        <form method="post" action="{% url 'usuarios:toggle' u.pk %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-warning" onclick="return confirm('¿Confirmas?')">
            {% if u.is_active %}Desactivar{% else %}Activar{% endif %}
          </button>
        </form>
        <form method="post" action="{% url 'usuarios:reset_password' u.pk %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Resetear contraseña temporal?')">
            Reset pass
          </button>
        </form>
      </td>
    </tr>
    {% empty %}
      <tr><td colspan="6" class="text-center text-muted">Sin usuarios</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}
