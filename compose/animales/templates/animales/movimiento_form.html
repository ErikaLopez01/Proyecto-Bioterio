{% extends "insumos/base.html" %}
{% block content %}

<h3 class="mb-3">Nuevo Movimiento</h3>

<div class="card">
  <div class="card-body">
    {% if grupo %}
      <p class="mb-3 text-muted">
        Registrando movimiento para el grupo:
        <strong>
          {{ grupo.especie }}{% if grupo.cepa %} / {{ grupo.cepa }}{% endif %}
          — @ {{ grupo.jaula }}
          (M:{{ grupo.cantidad_machos }} H:{{ grupo.cantidad_hembras }})
        </strong>
      </p>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Categoría</label>
          {{ form.categoria }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Motivo</label>
          {{ form.motivo }}
        </div>
      
        <div class="col-md-4" id="field-jaula-destino">
          <label class="form-label">Jaula destino</label>
          {{ form.jaula_destino }}
          <div class="form-text">
            Solo para movimientos de <strong>Traslado</strong>.
          </div>
        </div>
      </div>

      

      <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label class="form-label">Cantidad machos</label>
          {{ form.cantidad_machos }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Cantidad hembras</label>
          {{ form.cantidad_hembras }}
        </div>

        <div class="col-md-3" id="field-protocolo">
          <label class="form-label">Protocolo</label>
          {{ form.protocolo }}
          <div class="form-text">
            Requerido solo si el motivo es <strong>Protocolo</strong>.
          </div>
        </div>

        
      </div>

      <div class="mt-3">
        <label class="form-label">Observación</label>
        {{ form.observacion }}
      </div>

      {# mostramos errores no asociados a un campo específico #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger mt-3">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success">Registrar</button>
        <a class="btn btn-secondary" href="{% url 'animales:list' %}">Volver</a>
      </div>

      {# campos ocultos como grupo #}
      {{ form.grupo }}
    </form>
  </div>

    </div>
  {% endif %}

</div>

<script>
(function () {
  const catSelect = document.getElementById("id_categoria");
  const motSelect = document.getElementById("id_motivo");
  const protocoloField = document.getElementById("field-protocolo");
  const protocoloSelect = document.getElementById("id_protocolo");
  const jaulaField = document.getElementById("field-jaula-destino");
  const jaulaSelect = document.getElementById("id_jaula_destino");

  if (!catSelect || !motSelect) return;

  const allMotivoOptions = Array.from(motSelect.options);

  //Ingreso, Salida, Ajuste, Traslado
  const motivosPorCategoria = {
    "ingreso": ["Compra", "Nacimiento"],
    "salida": ["Venta", "Muerte", "Eutanasia", "Protocolo"],
    "traslado": ["Traslado"],
    "ajuste": ["Ajuste positivo", "Ajuste negativo"],
  };

  function categoriaKey() {
    const opt = catSelect.options[catSelect.selectedIndex];
    return opt ? opt.text.trim().toLowerCase() : "";
  }

  function syncMotivos() {
    const key = categoriaKey();
    const allowedTexts = motivosPorCategoria[key] || [];

    const placeholder = allMotivoOptions[0].value === "" ? allMotivoOptions[0] : null;

    motSelect.innerHTML = "";

    if (placeholder) {
      motSelect.appendChild(placeholder.cloneNode(true));
    }

    allMotivoOptions.forEach(opt => {
      if (opt.value === "") return;

      if (allowedTexts.includes(opt.text.trim())) {
        motSelect.appendChild(opt.cloneNode(true));
      }
    });

    syncProtocolo();
    syncJaula();
  }

  function motivoText() {
    const opt = motSelect.options[motSelect.selectedIndex];
    return opt ? opt.text.trim().toLowerCase() : "";
  }

  function syncProtocolo() {
    const isProtocolo = motivoText() === "protocolo";

    if (!protocoloSelect) return;

    protocoloSelect.disabled = !isProtocolo;
    if (!isProtocolo) {
      protocoloSelect.value = "";
    }
  }

  function syncJaula() {
    if (!jaulaSelect) return;

    const isTraslado = categoriaKey() === "traslado";
    jaulaSelect.disabled = !isTraslado;
    if (!isTraslado) {
      jaulaSelect.value = "";
    }
  }

  catSelect.addEventListener("change", syncMotivos);
  motSelect.addEventListener("change", syncProtocolo);

  // al cargar la página
  syncMotivos();
})();
</script>


{% endblock %}
